# リポジトリガイドライン

## プロジェクト構造とモジュール構成
- ルート: `nodes.py` は ComfyUI ノード定義を公開し、`config.ini` はデフォルトの API 資格情報を保持し、`requirements.txt` は実行時依存関係を宣言します。
- `py/api/` には型付きクライアントと機能ラッパー（例: `client.py`, `image_generator.py`）があり、`py/nodes.py` はそれらを ComfyUI ノードに適合させます。
- `examples/` にはスモークテスト用スクリプト `api_test.py` とワークフローの参照出力が含まれます。
- フロントエンドヘルパーはプレビュー制御用に `web/js/previewVideo.js` に配置されています。
- 機密性の高い資格情報は git に含めず、`config.ini` をローカルで設定してください。

## ビルド・テスト・開発用コマンド
- `uv pip install pyjwt httpx pillow numpy pydantic` — `requirements.txt` に依存せずに実行時依存関係をインストールします。
- `uv run python examples/api_test.py` — API ラッパーを検証します。実行前に `Client` キーを設定してください。
- `uv run python -m compileall py` — 出荷前にモジュールがコンパイル可能かの簡易チェックです。
- ComfyUI のチェックアウトから `ComfyUI/custom_nodes/ComfyUI-KLingAI-API` にシンボリックリンクまたはクローンし、ComfyUI を再起動して更新を読み込んでください。

## コーディングスタイルと命名規則
- PEP 8 に従い、インデントは 4 スペース、モジュール/関数はスネークケース、ノードクラスはパスカルケース（例: `ImageGeneratorNode`）を使用してください。
- リテラル値よりも明示的な列挙型や設定オブジェクト（`CameraControlConfig` 参照）を優先してください。
- ペイロードをシリアライズする際は `to_dict()` ヘルパーを使用し、KLing API のフィールド名と一致する説明的なキー名を維持してください。
- 提出前に `ruff format` や `black` などの自動整形ツールを実行し、インポートは標準/サードパーティ/ローカルの順に整理してください。

## テストガイドライン
- 新しいワークフローは `examples/api_test.py` で再現するか、シナリオ別スクリプトを `examples/` 配下に追加してください。
- 可能であればリモート呼び出しをモックし、困難な場合は環境変数でライブ実行を制御して CI ではスキップできるようにしてください。
- 期待される API レスポンスを取得し、テスト付近のコメントに前提条件を記述してください。
- `py/nodes.py` でテンソル/画像変換を検証し、ComfyUI プレビュー出力のリグレッションを確認してください。

## コミットおよびプルリクエストのガイドライン
- 既存の履歴に合わせた簡潔なタグ付きコミットサブジェクト（例: `[feat]`, `update:`）を使用し、命令形の動詞で続けてください。
- 本文では関連する Issue を参照し、API の変更、新しいノード入力、移行に関する注意事項を説明してください。
- プルリクエストには変更概要、ComfyUI ノード更新のスクリーンショットまたは GIF、テスト証跡（`examples/api_test.py` の出力）、設定上の考慮事項を含めてください。
- 対象モジュール（API かノードパイプライン）に詳しいメンテナにレビューを依頼し、承認を待ってからマージしてください。
